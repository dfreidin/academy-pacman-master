<html>
<head>
    <title>NinjaMan</title>
    <style type="text/css">
      * {
        margin: 0;
        padding: 0;
      }
      .row {
        line-height: 0;
      }
      .wall {
        background-color: blue;
        height: 40px;
        width: 40px;
        display: inline-block;
      }
      .blank {
        background-color: black;
        height: 40px;
        width: 40px;
        display: inline-block;
      }
      .sushi {
        background-color: black;
        height: 40px;
        width: 40px;
        display: inline-block;
        background-image: url("img/sushi.png");
        background-size: contain;
      }
      .onigiri {
        background-color: black;
        height: 40px;
        width: 40px;
        display: inline-block;
        background-image: url("img/onigiri.png");
        background-size: contain;
      }
      #ninjaman {
        background-color: black;
        height: 40px;
        width: 40px;
        display: inline-block;
        background-image: url("img/ninja.gif");
        background-size: contain;
        position: absolute;
      }
      #score {
        background-color: lightgreen;
        height: 40px;
        font-size: 30;
      }
    </style>
</head>
<body>
  <div id="world"></div>
  <div id="ninjaman"></div>
  <div id="score"></div>
</body>
<script type="text/javascript">
  var width=20, height=20;  // size of play area, minimum of 3x3
  var startingWorld = [];
  for(var i=0; i<height; i++){  // create a world of walls
    startingWorld[i] = [];
    for(var j=0; j<width; j++){
      startingWorld[i][j] = 1;
    }
  }
  startingWorld[1][1] = 0;  // empty starting space for NinjaMan
  var world = startingWorld.slice().map(function(row){return row.slice()});
  var worldDict = {
    0: 'blank',
    1: 'wall',
    2: 'sushi',
    3: 'onigiri'
  }
  var worldScore = 0;   // % of world which is playable, not counting border wall

  function genWorld(){
    for(var i=0; i<world.length; i++){
      for(var j=0; j<world[i].length; j++){
        if(i == 0 || i == world.length-1 || j == 0 || j == world[i].length-1){
          world[i][j] = 1;  // walls on borders
        }
        else {
          world[i][j] = Math.floor(Math.random() * 4);
        }
      }
    }
    world[1][1] = 0;  // always start in empty spot
  }

  function propegateCheck(arr){
    for(var i=0; i<arr.length; i++){  // check left-right, top-bottom
      for(var j=0; j<arr[i].length; j++){
        if(arr[i][j] != 1){
          arr[i-1][j] = world[i-1][j];
          arr[i+1][j] = world[i+1][j];
          arr[i][j-1] = world[i][j-1];
          arr[i][j+1] = world[i][j+1];
        }
      }
    }
    for(i=arr.length-1; i>=0; i--){  // check right-left, bottom-top
      for(j=arr[i].length-1; j>=0; j--){
        if(arr[i][j] != 1){
          arr[i-1][j] = world[i-1][j];
          arr[i+1][j] = world[i+1][j];
          arr[i][j-1] = world[i][j-1];
          arr[i][j+1] = world[i][j+1];
        }
      }
    }
    return arr;
  }

  function checkWorld(){
    var tempWorld = startingWorld.slice().map(function(row){return row.slice()});
    for(var i=0; i<2; i++){   // once is insufficient for certain complex worlds
      tempWorld = propegateCheck(tempWorld);
    }
    world = tempWorld;
    for(i=0; i<world.length; i++){
      for(var j=0; j<world[i].length; j++){
        if(world[i][j] != 1){
          worldScore++;
        }
      }
    }
    worldScore /= (world.length-2) * (world[0].length-2);
  }

  function drawWorld(){
    output = "";
    for(var row = 0; row < world.length; row++){
      output += "<div class = 'row'>";
      for(var col = 0; col < world[row].length; col++){
        output += "<div class = '"+worldDict[world[row][col]]+"'></div>"
      }
      output += "</div>";
    }
    document.getElementById("world").innerHTML = output;
    document.getElementById("score").style.width = world[0].length * 40 + "px";
    document.getElementById("score").innerHTML = "Score: " + ninjaman.score;
  }

  var ninjaman = {
    row: 1,
    col: 1,
    score: 0
  }

  function moveHor(dir){
    if(world[ninjaman.row][ninjaman.col+dir] != 1){
      ninjaman.col += dir;
    }
  }
  function moveVer(dir){
    if(world[ninjaman.row+dir][ninjaman.col] != 1){
      ninjaman.row += dir;
    }
  }

  function drawNinjaman(){
    document.getElementById("ninjaman").style.top = (40*ninjaman.row) + "px"
    document.getElementById("ninjaman").style.left = (40*ninjaman.col) + "px"
  }

  document.onkeydown = function(e){
    if(e.keyCode == 37){  //left
      moveHor(-1);
    }
    if(e.keyCode == 39){  //right
      moveHor(1);
    }
    if(e.keyCode == 38){  //up
      moveVer(-1);
    }
    if(e.keyCode == 40){  //down
      moveVer(1);
    }
    drawNinjaman();
    if(world[ninjaman.row][ninjaman.col] == 2){
      ninjaman.score++;
    }
    if(world[ninjaman.row][ninjaman.col] == 3){
      ninjaman.score += 10;
    }
    world[ninjaman.row][ninjaman.col] = 0;
    drawWorld();
  }

  while(worldScore < 0.5){  // don't have too many walls
    while(world[1][2] == 1 && world[2][1] == 1){  // no isolated starting point
      genWorld();
    }
    checkWorld();
  }
  drawWorld();
  drawNinjaman();

</script>
</html>
